#include <stdio.h>
#include <stdlib.h>
#include <lodepng.h>
#include <zbar.h>
#include <stdint.h>

zbar_image_scanner_t *scanner = NULL;
uint8_t teststring[] = {0xe4,0xff,0x29,00,0x50,0xc,0x4a,0x77,0x68,0x31,0xaf,0x2b,00,00,00,00,0xec,0xff,0x29,00,0x1f,0x9e,0x48,0x77,0xff,0xff,0xff,0xff,0xec,0xd6,0x4a,0x77,00,00,00,00,00,00,00,00,0xa0,0x12,0x40,00,00,0xe0,0xfd,0x7f,00,00,00,00,0x41,0x63,0x74,0x78,0x20,00,00,00,0x1,00,00,00,0x5c,0x33,00,00,0xdc,00,00,00,00,00,00,00,0x20,00,00,00,00,00,00,00,0x14,00,00,00,0x1,00,00,00,0x7,00,00,00,0x34,00,00,00,0x7c,0x1,00,00,0x1,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,0x2,00,00,00,0x4e,0xef,0x26,0x1a,0x98,0x2,00,00,0x44,00,00,00,0xe0,0x2,00,00,0x64,0x2,00,00,00,00,00,00,0xba,0x71,0x32,0xf3,0x44,0x5,00,00,0x4a,00,00,00,0x90,0x5,00,00,0x4e,0x3,00,00,00,00,00,00,0x5b,0x49,0x59,0x2d,0xe0,0x8,00,00,0x32,00,00,00,0x14,0x9,00,00,0x6,0x3,00,00,00,00,00,00,0xcd,0xea,0xce,0x32,0x1c,0xc,00,00,0x42,00,00,00,0x60,0xc,00,00,0x3c,0x3,00,00,00,00,00,00,0xc8,0x5f,0x50,0x38,0x9c,0xf,00,00,0x5e,00,00,00,0xfc,0xf,00,00,0x6e,0x3,00,00,00,00,00,00,0x44,0x5,0x28,0xb1,0x6c,0x13,00,00,0x56,00,00,00,0xc4,0x13,00,00,0x9e,0x3,00,00,0x10,00,00,00,0x9,00,00,00,0xec,00,00,00,0x2,00,00,00,0x1,00,00,00,0x7c,0x1,00,00,0x20,0x16,00,00,0x1,00,00,00,0x2,00,00,00,0x9c,0x17,00,00,0xa0,0x7,00,00,0x1,00,00,00,0x3,00,00,00,0x3c,0x1f,00,00,0x8c,0xe,00,00,0x1,00,00,00,0x4,00,00,00,0xc8,0x2d,00,00,0x14,0x3,00,00,0x2,00,00,00,0x5,00,00,00,0xdc,0x30,00,00,0x98,00,00,00,0x2,00,00,00,0x6,00,00,00,0x74,0x31,00,00,0xcc,00,00,00,0x2,00,00,00,0x7,00,00,00,0x40,0x32,00,00,0xf0,00,00,00,0x1,00,00,00,0x9,00,00,00,0x30,0x33,00,00,0x28,00,00,00,0x2,00,00,00,0xb,00,00,00,0x58,0x33,00,00,0x4,00,00,00,0x1,00,00,00,0x53,0x73,0x48,0x64,0x2c,00,00,00,0x1,00,00,00,0x1,00,00,00,0x1,00,00,00,0x6,00,00,00,0x8c,00,00,00,0x1,00,00,00,0xe8,0x15,00,00,0x2c,00,00,00,0x5e,00,00,00,0x5e,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,0x2,00,00,00,0x24,00,00,00,0x38,00,00,00,00,00,00,00,0x43,00,0x3a,00,0x5c,00,0x57,00,0x69,00,0x6e,00,0x64,00,0x6f,00,0x77,00,0x73,00,0x5c,00,0x57,00,0x69,00,0x6e,00,0x53,00,0x78,00,0x73,00,0x5c,00,00,00,00,00,0x4e,0xef,0x26,0x1a,0x1c,0x1,00,00,0x44,00,00,00,0x64,0x1,00,00,0x64,0x2,00,00,0x1,00,00,00,0xba,0x71,0x32,0xf3,0xc8,0x3,00,00,0x4a,00,00,00,0x14,0x4,00,00,0x4e,0x3,00,00,0x2,00,00,00,0x5b,0x49,0x59,0x2d,0x64,0x7,00,00,0x32,00,00,00,0x98,0x7,00,00,0x6,0x3,00,00,0x3,00,00,00,0xcd,0xea,0xce,0x32,0xa0,0xa,00,00,0x42,00,00,00,0xe4,0xa,00,00,0x3c,0x3,00,00,0x4,00,00,00,0xc8,0x5f,0x50,0x38,0x20,0xe,00,00,0x5e,00,00,00,0x80,0xe,00,00,0x6e,0x3,00,00,0x5,00,00,00,0x44,0x5,0x28,0xb1,0xf0,0x11,00,00,0x56,00,00,00,0x48,0x12,00,00,0x9e,0x3,00,00,0x6,00,00,00,0x4d,00,0x69,00,0x63,00,0x72,00,0x6f,00,0x73,00,0x6f,00,0x66,00,0x74,00,0x2e,00,0x57,00,0x69,00,0x6e,00,0x64,00,0x6f,00,0x77,00,0x73,00,0x2e,00,0x53,00,0x79,00,0x73,00,0x74,00,0x65,00,0x6d,00,0x43,00,0x6f,00,0x6d,00,0x70,00,0x61,00,0x74,00,0x69,00,0x62,00,0x6c,00,0x65,00,00,00,00,00,0x6c,00,00,00,0x1,00,00,00,0xe,0x1,00,00,0xd0,0x1,00,00,0x2,00,00,00,0x2c,00,00,00,0xde,0x2,00,00,0xa3,0x70,0x53,0x3a,0xff,0xba,0xd0,0x1,0x1,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,0x1,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,0xba,00,00,00,0xc,0x3,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,0x4d,00,0x69,00,0x63,00,0x72,00,0x6f,00,0x73,00,0x6f,00,0x66,00,0x74,00,0x2e,00,0x57,00,0x69,00,0x6e,00,0x64,00,0x6f,00,0x77,00,0x73,00,0x2e,00,0x53,00,0x79,00,0x73,00,0x74,00,0x65,00,0x6d,00,0x43,00,0x6f,00,0x6d,00,0x70,00,0x61,00,0x74,00,0x69,00,0x62,00,0x6c,00,0x65,00,0x2c,00,0x70,00,0x72,00,0x6f,00,0x63,00,0x65,00,0x73,00,0x73,00,0x6f,00,0x72,00,0x41,00,0x72,00,0x63,00,0x68,00,0x69,00,0x74,00,0x65,00,0x63,00,0x74,00,0x75,00,0x72,00,0x65,00,0x3d,00,0x22,00,0x78,00,0x38,00,0x36,00,0x22,00,0x2c,00,0x70,00,0x75,00,0x62,00,0x6c,00,0x69,00,0x63,00,0x4b,00,0x65,00,0x79,00,0x54,00,0x6f,00,0x6b,00,0x65,00,0x6e,00,0x3d,00,0x22,00,0x36,00,0x35,00,0x39,00,0x35,00,0x62,00,0x36,00,0x34,00,0x31,00,0x34,00,0x34,00,0x63,00,0x63,00,0x66,00,0x31,00,0x64,00,0x66,00,0x22,00,0x2c,00,0x74,00,0x79,00,0x70,00,0x65,00,0x3d,00,0x22,00,0x77,00,0x69,00,0x6e,00,0x33,00,0x32,00,0x22,00,0x2c,00,0x76,00,0x65,00,0x72,00,0x73,00,0x69,00,0x6f,00,0x6e,00,0x3d,00,0x22,00,0x36,00,0x2e,00,0x30,00};

int main (void)
{
    //if(argc < 2) return(1);
	char * filename = "mustard2.png";
    /* create a reader */
    scanner = zbar_image_scanner_create();

    /* configure the reader */
    zbar_image_scanner_set_config(scanner, 0, ZBAR_CFG_ENABLE, 1);

    /* obtain image data */
    int width = 0, height = 0;
    void *raw = NULL;

    /* declare LodePNG related vars */
    unsigned error;
    unsigned char* rawimage;
    unsigned char* rawimagebegin = rawimage;
    unsigned char* png = 0;
    size_t pngsize;
    LodePNGState state;

    /* customize the state to give us 8bit Greyscale or Y800 expected by ZBAR*/
    lodepng_state_init(&state);
    state.info_raw.bitdepth = 8;
    state.info_raw.colortype = LCT_GREY;

    /* load the png file and get the rawimage data*/
    error = lodepng_load_file(&png, &pngsize, filename);
    if(!error) error = lodepng_decode(&rawimage, &width, &height, &state, png, pngsize);
    if(error) printf("error %u: %s\n", error, lodepng_error_text(error));
    free(png);

    lodepng_state_cleanup(&state);
    //free(image);

    /* encode it back into a file to see if it's grayscale - uses only R values according
     * to lodepng documentation */
    //unsigned error2 = lodepng_encode(&png, &pngsize, rawimage, width, height, &state);
    //if(!error2) lodepng_save_file(png, pngsize, "encode.png");

    /* print raw data for debug */
    //rawimage[width*height] = '0';
    int i=0;
    printf("width = %d\n", width);
    printf("height = %d\n", height);
    printf("image size = %d", width*height);
    printf("\nraw string:\n");
    for (i=0; i<1140; i++){
    	printf("%#02x,", *rawimagebegin);
    	rawimagebegin++;
    }
    printf("\ndone\r\n");

    /* wrap image data */
    zbar_image_t *image = zbar_image_create();
    zbar_image_set_format(image, zbar_fourcc('G','R','E','Y'));
    zbar_image_set_size(image, width, height);
    zbar_image_set_data(image, rawimage, width * height, zbar_image_free_data);

    /* scan the image for barcodes */
    int n = zbar_scan_image(scanner, image);

    /* extract results */
    const zbar_symbol_t *symbol = zbar_image_first_symbol(image);
    for(; symbol; symbol = zbar_symbol_next(symbol)) {
        /* print the results */
        zbar_symbol_type_t typ = zbar_symbol_get_type(symbol);
        const char *data = zbar_symbol_get_data(symbol);
        printf("decoded %s symbol \"%s\"\n",
               zbar_get_symbol_name(typ), data);
    }

    /* clean up */
    zbar_image_destroy(image);
    zbar_image_scanner_destroy(scanner);
    //free(rawimage);
    return(0);
}
